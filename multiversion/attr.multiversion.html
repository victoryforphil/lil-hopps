<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Provides function multiversioning."><title>multiversion in multiversion - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-fa3bb1812debf86c.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="multiversion" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.1 (a28077b28 2023-12-04)" data-channel="1.74.1" data-search-js="search-8be46b629f5f14a8.js" data-settings-js="settings-74424d7eec62a23e.js" ><script src="../static.files/storage-fec3eaa3851e447d.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-c5bd66d33317d69f.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-5d8b3c7633ad77ba.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc attr"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../multiversion/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a></nav><nav class="sidebar"><a class="logo-container" href="../multiversion/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><div class="sidebar-elems"><h2><a href="index.html">In multiversion</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Attribute Macro <a href="index.html">multiversion</a>::<wbr><a class="attr" href="#">multiversion</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/multiversion_macros/lib.rs.html#16-19">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>#[multiversion]</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Provides function multiversioning.</p>
<p>The annotated function is compiled multiple times, once for each target, and the
best target is selected at runtime.</p>
<p>Options:</p>
<ul>
<li><code>targets</code>
<ul>
<li>Takes a list of targets, such as <code>targets(&quot;x86_64+avx2&quot;, &quot;x86_64+sse4.1&quot;)</code>.</li>
<li>Target priority is first to last.  The first matching target is used.</li>
<li>May also take a special value <code>targets = &quot;simd&quot;</code> to automatically multiversion for common
SIMD target features.</li>
</ul>
</li>
<li><code>attrs</code>
<ul>
<li>Takes a list of attributes to attach to each target clone function.</li>
</ul>
</li>
<li><code>dispatcher</code>
<ul>
<li>Selects the preferred dispatcher. Defaults to <code>default</code>.
<ul>
<li><code>default</code>: If the <code>std</code> feature is enabled, uses either <code>direct</code> or <code>indirect</code>,
attempting to choose the fastest choice.  If the <code>std</code> feature is not enabled, uses <code>static</code>.</li>
<li><code>static</code>: Detects features at compile time from the enabled target features.</li>
<li><code>indirect</code>: Detect features at runtime, and dispatches with an indirect function call.
Cannot be used for generic functions, <code>async</code> functions, or functions that take or return an
<code>impl Trait</code>.  This is usually the default.</li>
<li><code>direct</code>: Detects features at runtime, and dispatches with direct function calls. This is
the default on functions that do not support indirect dispatch, or in the presence of
indirect branch exploit mitigations such as retpolines.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="example"><a href="#example">Example</a></h2>
<p>This function is a good candidate for optimization using SIMD.
The following compiles <code>square</code> three times, once for each target and once for the generic
target.  Calling <code>square</code> selects the appropriate version at runtime.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>multiversion::multiversion;

<span class="attr">#[multiversion(targets(<span class="string">&quot;x86_64+avx&quot;</span>, <span class="string">&quot;x86+sse&quot;</span>))]
</span><span class="kw">fn </span>square(x: <span class="kw-2">&amp;mut </span>[f32]) {
    <span class="kw">for </span>v <span class="kw">in </span>x {
        <span class="kw-2">*</span>v <span class="kw-2">*</span>= <span class="kw-2">*</span>v
    }
}</code></pre></div>
<p>This example is similar, but targets all supported SIMD instruction sets (not just the two shown above):</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>multiversion::multiversion;

<span class="attr">#[multiversion(targets = <span class="string">&quot;simd&quot;</span>)]
</span><span class="kw">fn </span>square(x: <span class="kw-2">&amp;mut </span>[f32]) {
    <span class="kw">for </span>v <span class="kw">in </span>x {
        <span class="kw-2">*</span>v <span class="kw-2">*</span>= <span class="kw-2">*</span>v
    }
}</code></pre></div>
<h2 id="notes-on-dispatcher-performance"><a href="#notes-on-dispatcher-performance">Notes on dispatcher performance</a></h2><h4 id="feature-detection-is-performed-only-once"><a href="#feature-detection-is-performed-only-once">Feature detection is performed only once</a></h4>
<p>The <code>direct</code> and <code>indirect</code> dispatchers perform function selection on the first invocation.
This is implemented with a static atomic variable containing the selected function.</p>
<p>This implementation has a few benefits:</p>
<ul>
<li>The function selector is typically only invoked once.  Subsequent calls are reduced to an
atomic load.</li>
<li>If called in multiple threads, there is no contention.  Both threads may perform feature
detection, but the atomic ensures these are synchronized correctly.</li>
</ul>
<h4 id="dispatcher-elision"><a href="#dispatcher-elision">Dispatcher elision</a></h4>
<p>If the optimal set of features is already known to exist at compile time, the entire dispatcher
is elided. For example, if the highest priority target requires <code>avx512f</code> and the function is
compiled with <code>RUSTFLAGS=-Ctarget-cpu=skylake-avx512</code>, the function is not multiversioned and
the highest priority target is used.</p>
</div></details></section></div></main></body></html>